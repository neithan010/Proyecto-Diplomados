
<?php
/*
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);
*/
?>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
</head>

<body>

<div class="container my-2">
	<h2>Adjuntar Documentos</h2>
<?php
function limpiar_caracteres_especiales($str) {

  $a = array('�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', '�', 'A', 'a', 'A', 'a', 'A', 'a', 'C', 'c', 'C', 'c', 'C', 'c', 'C', 'c', 'D', 'd', '�', 'd', 'E', 'e', 'E', 'e', 'E', 'e', 'E', 'e', 'E', 'e', 'G', 'g', 'G', 'g', 'G', 'g', 'G', 'g', 'H', 'h', 'H', 'h', 'I', 'i', 'I', 'i', 'I', 'i', 'I', 'i', 'I', 'i', '?', '?', 'J', 'j', 'K', 'k', 'L', 'l', 'L', 'l', 'L', 'l', '?', '?', 'L', 'l', 'N', 'n', 'N', 'n', 'N', 'n', '?', 'O', 'o', 'O', 'o', 'O', 'o', '�', '�', 'R', 'r', 'R', 'r', 'R', 'r', 'S', 's', 'S', 's', 'S', 's', '�', '�', 'T', 't', 'T', 't', 'T', 't', 'U', 'u', 'U', 'u', 'U', 'u', 'U', 'u', 'U', 'u', 'U', 'u', 'W', 'w', 'Y', 'y', '�', 'Z', 'z', 'Z', 'z', '�', '�', '?', '�', 'O', 'o', 'U', 'u', 'A', 'a', 'I', 'i', 'O', 'o', 'U', 'u', 'U', 'u', 'U', 'u', 'U', 'u', 'U', 'u', '?', '?', '?', '?', '?', '?');
  $b = array('A', 'A', 'A', 'A', 'A', 'A', 'AE', 'C', 'E', 'E', 'E', 'E', 'I', 'I', 'I', 'I', 'D', 'N', 'O', 'O', 'O', 'O', 'O', 'O', 'U', 'U', 'U', 'U', 'Y', 's', 'a', 'a', 'a', 'a', 'a', 'a', 'ae', 'c', 'e', 'e', 'e', 'e', 'i', 'i', 'i', 'i', 'n', 'o', 'o', 'o', 'o', 'o', 'o', 'u', 'u', 'u', 'u', 'y', 'y', 'A', 'a', 'A', 'a', 'A', 'a', 'C', 'c', 'C', 'c', 'C', 'c', 'C', 'c', 'D', 'd', 'D', 'd', 'E', 'e', 'E', 'e', 'E', 'e', 'E', 'e', 'E', 'e', 'G', 'g', 'G', 'g', 'G', 'g', 'G', 'g', 'H', 'h', 'H', 'h', 'I', 'i', 'I', 'i', 'I', 'i', 'I', 'i', 'I', 'i', 'IJ', 'ij', 'J', 'j', 'K', 'k', 'L', 'l', 'L', 'l', 'L', 'l', 'L', 'l', 'l', 'l', 'N', 'n', 'N', 'n', 'N', 'n', 'n', 'O', 'o', 'O', 'o', 'O', 'o', 'OE', 'oe', 'R', 'r', 'R', 'r', 'R', 'r', 'S', 's', 'S', 's', 'S', 's', 'S', 's', 'T', 't', 'T', 't', 'T', 't', 'U', 'u', 'U', 'u', 'U', 'u', 'U', 'u', 'U', 'u', 'U', 'u', 'W', 'w', 'Y', 'y', 'Y', 'Z', 'z', 'Z', 'z', 'Z', 'z', 's', 'f', 'O', 'o', 'U', 'u', 'A', 'a', 'I', 'i', 'O', 'o', 'U', 'u', 'U', 'u', 'U', 'u', 'U', 'u', 'U', 'u', 'A', 'a', 'AE', 'ae', 'O', 'o'); 
  
  $str=str_replace($a, $b, $str);
  
  return strtolower(preg_replace(array('/[^a-zA-Z0-9 -]/', '/[ -]+/', '/^-|-$/'),array('', '-', ''), $str)); 

	
}

$id_form = $_REQUEST['id_form'];
$dir = $_SERVER{'DOCUMENT_ROOT'}."/apps/cdg/postulacion/admision/Fichas/".$id_form."";

if ($_FILES["file_cv"]['name'] != "") {


	// obtenemos los datos del archivo
	$tamano = $_FILES["file_cv"]['size'];
	$tipo = $_FILES["file_cv"]['type'];
	$archivo = $_FILES["file_cv"]['name'];
	$arr_archivo=explode(".",$archivo);
	$extension=$arr_archivo[(count($arr_archivo)-1)];
	$archivo=limpiar_caracteres_especiales($archivo);
	$archivo=substr($archivo,0,(strlen($archivo)-strlen($extension))).'.'.$extension;
	$prefijo = ''; //substr(md5(uniqid(rand())),0,6);
	

	//$nombre_cv=$id_form."_".$prefijo."_".$archivo;
	$nombre_cv=$archivo;

	if (strlen($nombre_cv)>50){
		 $nombre_cv=substr($nombre_cv,-50,50);
		 //$nombre_cv=limpiar_caracteres_especiales($nombre_cv);
	}
	//echo $nombre_cv.'<p>';
	
	//$dir = $_SERVER{'DOCUMENT_ROOT'}."apps/cdg/postulacion/admision/Fichas/".$id_form."";
	//echo '<pre>'.$dir.'</pre>';
	
	//Si no existe el directorio lo creo
	if(!is_dir($dir)){
		mkdir($dir, 0777);
	}
	//$destino ="Fichas/".$id_form."/".$nombre_cv;
	$destino =$dir."/".$nombre_cv;
	if (copy($_FILES['file_cv']['tmp_name'],$destino)) {
		//echo	$status = "&copy;";
		echo '<img src="../img/check.gif">';
	}
	echo 'Archivo actualizado';
	//echo '<script language="javascript">if(confirm("Archivo actualizado")){}window.close();</script>';
}else{
?>
<form name="frm_addcv" method="post" enctype="multipart/form-data" action="">
   <div style="float:left">Adjuntar Documentos<br />
(Certificados, cartas, etc.)[.]</div>
    <div style="float: left;"><input id="file_cv" name="file_cv" type="file" size="40"><input id="Guardar" name="Guardar" type="submit" value="Guardar DOC."  />
	</div>
</form>
<?php
}

?>
<div class="clearfix"></div>
<p></p>
<ul>Documentos:
    <?php
    //$dir = $_SERVER{'DOCUMENT_ROOT'}."/apps/cdg/postulacion/admision/Fichas/".$id_form."";
    if(is_dir($dir)){
        $directorio=opendir($dir); 
       while ($archivo = readdir($directorio)) { 
            if($archivo != '.' && $archivo != '..' && $archivo != 'bk' && $archivo != 'BK'){
?>
<li><a href="https://intranet.unegocios.cl/apps/cdg/postulacion/admision/Fichas/<?php echo $id_form;?>/<?php echo $archivo;?>?k=<?php echo rand(1,100)?>" target="_blank"><?php echo $archivo;?></a></li>
<?php
            }
        }
    }
    ?>
</ul> 

<a href="ficha_postulante.php?id_postulacion=<?php echo $id_form;?>" class="btn btn-primary" target="_self">volver Ficha</a>

</div>
</body>
</html>